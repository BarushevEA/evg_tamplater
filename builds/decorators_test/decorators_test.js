(()=>{"use strict";var e,s,t,i;(i=e||(e={})).INIT="INIT",i.STARTED="STARTED",i.STOPPED="STOPPED",i.PROCESS="PROCESS",i.DESTROYED="DESTROYED",i.UNDEFINED="UNDEFINED",i.DELETED="DELETED",i.READY="READY",(t=s||(s={})).NEGATIVE_DELAY="Delay must be a positive number.",t.TYPE_INVALID="TYPE_INVALID",t.NAME_IS_NOT_PRESENT="NAME_IS_NOT_PRESENT",t.INSTANCE_DESTROYED="INSTANCE_DESTROYED";const r=e=>({isApplied:!0,state:e}),n=e=>({isApplied:!1,state:e}),o=(e,s)=>e>s?e:s,h=(e,s)=>0===e?s:0===s?e:e>s?s:e,a=(e,s)=>Math.round((e+s)/2),l=e=>"next"in e?s=>e.next(s):e;class c{constructor(e){this.pipe=e,this.counter=e.chain.length?e.chain.length:0}case(e){this.counter++;const s=this.counter,t=this.pipe.chain;return t.push((i=>{i.isAvailable=!0,e(i.payload)&&(i.isBreak=!0),s!==t.length||i.isBreak||(i.isAvailable=!1)})),this}pushCases(e){if(!Array.isArray(e))return this;for(let s=0;s<e.length;s++)this.case(e[s]);return this}}class u{constructor(){this.chain=[],this.flow={isBreak:!1,isUnsubscribe:!1,isAvailable:!1,payload:null}}processChain(e){const s=this.chain,t=this.flow;for(let e=0;e<s.length;e++){if(t.isUnsubscribe=!1,t.isAvailable=!1,s[e](t),t.isUnsubscribe)return this.unsubscribe();if(!t.isAvailable)return;if(t.isBreak)break}return e(t.payload)}setOnce(){return this.push((e=>{this.listener(e.payload),e.isUnsubscribe=!0}))}unsubscribeBy(e){return this.push((s=>{s.isAvailable=!0,e(s.payload)&&(s.isUnsubscribe=!0)}))}refine(e){return this.push((s=>{e(s.payload)&&(s.isAvailable=!0)}))}pushRefiners(e){if(!Array.isArray(e))return this;for(let s=0;s<e.length;s++)this.refine(e[s]);return this}switch(){return new d(this)}then(e){return this.push((s=>{s.payload=e(s.payload),s.isAvailable=!0}))}serialize(){return this.push((e=>{e.payload=JSON.stringify(e.payload),e.isAvailable=!0}))}deserialize(){return this.push((e=>{e.payload=JSON.parse(e.payload),e.isAvailable=!0}))}push(e){return this.chain.push(e),this}}class d extends c{subscribe(e,s){return this.pipe.subscribe(e,s)}}class f extends u{get order(){return this._order}constructor(e,s){super(),this._order=0,this.isPaused=!1,this.isPipe=!1,this.errorHandler=(e,s)=>{console.log(`(Unit of SubscribeObject).send(${e}) ERROR:`,s)},this.observable=e,this.isPipe=!!s}subscribe(e,s){return this.listener=(e=>{if(Array.isArray(e)){const s=[];for(let t=0;t<e.length;t++)s.push(l(e[t]));return e=>{for(let t=0;t<s.length;t++)s[t](e)}}return l(e)})(e),s&&(this.errorHandler=s),this}unsubscribe(){this.observable&&(this.observable.unSubscribe(this),this.observable=null,this.listener=null,this.chain.length=0)}send(e){try{this.flow.payload=e,this.flow.isBreak=!1,this.processValue(e)}catch(s){this.errorHandler(e,s)}}resume(){this.isPaused=!1}pause(){this.isPaused=!0}set order(e){this._order=e}processValue(e){const s=this.listener;return s?this.observable&&!this.isPaused?this.isPipe?this.processChain(s):s(e):void 0:this.unsubscribe()}}class p{constructor(){this.chain=[],this.flow={isBreak:!1,isAvailable:!1,payload:null},this.response={isOK:!1,payload:void 0}}get isEmpty(){return!this.chain.length}pushFilters(e){if(!Array.isArray(e))return this;for(let s=0;s<e.length;s++)this.filter(e[s]);return this}filter(e){return this.push((s=>{e(s.payload)&&(s.isAvailable=!0)}))}push(e){return this.chain.push(e),this}switch(){return new D(this)}processChain(e){const s=this.chain,t=this.flow,i=this.response;i.isOK=!1,i.payload=void 0,t.payload=e,t.isBreak=!1;try{for(let e=0;e<s.length;e++){if(t.isAvailable=!1,s[e](t),!t.isAvailable)return i;if(t.isBreak)break}}catch(e){return this.errHandler?this.errHandler(e,"Filter.processChain ERROR:"):console.log("Filter.processChain ERROR:",e),i}return i.isOK=!0,i.payload=t.payload,i}addErrorHandler(e){this.errHandler=e}}class D extends c{}class E{constructor(e){this.value=e,this.listeners=[],this.isStop=!0,this.isKilled=!1,this.isProcess=!1,this.trash=[],this.filters=new p}addFilter(e){return e&&this.filters.addErrorHandler(e),this.filters}disable(){this.isStop=!1}enable(){this.isStop=!0}get isEnable(){return this.isStop}next(e){if(!this.isKilled&&this.isStop&&(this.filters.isEmpty||this.filters.processChain(e).isOK)){this.isProcess=!0,this.value=e;for(let s=0;s<this.listeners.length;s++)this.listeners[s].send(e);this.isProcess=!1,this.trash.length&&this.handleListenersForUnsubscribe()}}stream(e){if(!this.isKilled&&this.isStop)for(let s=0;s<e.length;s++)this.next(e[s])}get isDestroyed(){return this.isKilled}unSubscribe(e){this.isKilled||(this.isProcess&&e?this.trash.push(e):this.listeners&&((e,s)=>{const t=e.indexOf(s);-1!==t&&(e[t]=e[e.length-1],e.length=e.length-1)})(this.listeners,e))}destroy(){this.value=null,this.unsubscribeAll(),this.listeners=null,this.isKilled=!0}unsubscribeAll(){this.isKilled||(this.listeners.length=0)}getValue(){if(!this.isKilled)return this.value}size(){return this.isKilled?0:this.listeners.length}subscribe(e,s){if(!this.isListener(e))return;const t=new f(this,!1);return this.addObserver(t,e,s),t}addObserver(e,s,t){e.subscribe(s,t),this.listeners.push(e)}isListener(e){return!this.isKilled&&!!e}pipe(){if(this.isKilled)return;const e=new f(this,!0);return this.listeners.push(e),e}handleListenersForUnsubscribe(){const e=this.trash.length;for(let s=0;s<e;s++)this.unSubscribe(this.trash[s]);this.trash.length=0}}class y{constructor(){this.state$=new E(e.UNDEFINED)}get state(){return this.state$.isDestroyed?e.DESTROYED:this.state$.getValue()??e.UNDEFINED}start(){if(this.isDestroyed())return n(e.DESTROYED);const s=this.startProcess();return s.isApplied?r(s.state):s}stop(){if(this.isDestroyed())return n(e.DESTROYED);const s=this.stopProcess();return s.isApplied?r(s.state):s}destroy(){return this.stop(),this.state$.next(e.DESTROYED),this.state$.destroy(),r(e.DESTROYED)}subscribeOnState(e){if(!this.isDestroyed())return this.state$.subscribe(e)}subscribeOnProcess(s){if(!this.isDestroyed())return this.state$.pipe()?.refine((s=>s===e.PROCESS)).subscribe(s)}isDestroyed(){return this.state===e.DESTROYED}}class T extends y{constructor(){super(),this.intervalId=0,this.delay=0}setInterval(t){return this.isDestroyed()?n(e.DESTROYED):this.intervalId?n(e.STARTED):t<0?n(s.NEGATIVE_DELAY):(this.delay=t,this.state$.next(e.INIT),r(e.INIT))}startProcess(){return this.intervalId=setInterval((()=>{this.state$.next(e.PROCESS)}),this.delay),this.state$.next(e.STARTED),r(e.STARTED)}stopProcess(){return clearInterval(this.intervalId),this.intervalId=0,this.state$.next(e.STOPPED),r(e.STOPPED)}}const O=e=>{const s=e._counter;e.countOfUsesPerMinute=s.minutes,e.countOfUsesPerMinuteMax=o(e.countOfUsesPerMinuteMax,s.minutes),e.countOfUsesPerMinuteMin=h(e.countOfUsesPerMinuteMin,s.minutes),e.countOfUsesPerMinuteAvg=a(e.countOfUsesPerMinuteAvg,s.minutes)},b=e=>{const s=e._counter;e.countOfUsesPerHour=s.hours,e.countOfUsesPerHourMax=o(e.countOfUsesPerHourMax,s.hours),e.countOfUsesPerHourMin=h(e.countOfUsesPerHourMin,s.hours),e.countOfUsesPerHourAvg=a(e.countOfUsesPerHourAvg,s.hours)},m=e=>{const s=e._counter;e.countOfUsesPerDay=s.days,e.countOfUsesPerDayMax=o(e.countOfUsesPerDayMax,s.days),e.countOfUsesPerDayMin=h(e.countOfUsesPerDayMin,s.days),e.countOfUsesPerDayAvg=a(e.countOfUsesPerDayAvg,s.days)},S=new class{constructor(){this.metrics={},this._state=e.STOPPED,this.perSecondTimer=new T,this.perSecondTimer.setInterval(1e3),this.perMinuteTimer=new T,this.perMinuteTimer.setInterval(6e4),this.perHourTimer=new T,this.perHourTimer.setInterval(36e5),this.perDayTimer=new T,this.perDayTimer.setInterval(864e5)}get length(){return Object.keys(this.metrics).length}stop(){if(this.isDestroyed())return n(s.INSTANCE_DESTROYED);this.perSecondTimer.stop(),this.perMinuteTimer.stop(),this.perHourTimer.stop(),this.perDayTimer.stop();for(const e in this.metrics){const s=this.metrics[e];s._counter.days=0,s._counter.hours=0,s._counter.minutes=0,s._counter.seconds=0}return this._state=e.STOPPED,r(e.STOPPED)}destroy(){return this.isDestroyed()?n(s.INSTANCE_DESTROYED):(this.stop(),this.clearFunc(),this.perSecondTimer.destroy(),this.perMinuteTimer.destroy(),this.perHourTimer.destroy(),this.perDayTimer.destroy(),this._state=e.DESTROYED,r(e.DESTROYED))}get state(){return this._state}deleteFunc(t){if(this.isDestroyed())return n(s.INSTANCE_DESTROYED);if(t in this.metrics){const s=this.metrics[t];return s._deleteObj.isDeleted=!0,s._deleteObj=null,delete this.metrics[t],r(e.DELETED)}return n(s.NAME_IS_NOT_PRESENT)}start(){return this.isDestroyed()?n(s.INSTANCE_DESTROYED):this._state===e.STARTED?n(e.STARTED):(this.perSecondTimer.start(),this.perMinuteTimer.start(),this.perHourTimer.start(),this.perDayTimer.start(),this._state=e.STARTED,r(e.STARTED))}decorate(s,t){const{deleteObj:i,metric:r}=this.createMetric(s);return(...s)=>{if(i.isDeleted)return t(...s);const n=Date.now();this.trackMetric(r);try{return t(...s)}catch(s){throw i.isDeleted||this._state!==e.STARTED||r.countOfErrors++,s}finally{i.isDeleted||this._state!==e.STARTED||(r.timePerCall=Date.now()-n,r.totalExecutionTime+=r.timePerCall)}}}decorateAsync(s,t){const{deleteObj:i,metric:r}=this.createMetric(s);return async(...s)=>{if(i.isDeleted)return await t(...s);const n=Date.now();this.trackMetric(r);try{return await t(...s)}catch(s){throw i.isDeleted||this._state!==e.STARTED||r.countOfErrors++,s}finally{i.isDeleted||this._state!==e.STARTED||(r.timePerCall=Date.now()-n,r.totalExecutionTime+=r.timePerCall)}}}isDestroyed(){return this._state===e.DESTROYED}createMetric(e){if(e in this.metrics)throw new Error(`A function with the name "${e}" is already decorated`);if(this.isDestroyed())throw new Error(s.INSTANCE_DESTROYED);const t={isDeleted:!1};this.metrics[e]={countOfUses:0,countOfErrors:0,totalExecutionTime:0,timePerCall:0,countOfUsesPerSecond:0,countOfUsesPerMinute:0,countOfUsesPerHour:0,countOfUsesPerDay:0,countOfUsesPerDayAvg:0,countOfUsesPerDayMax:0,countOfUsesPerDayMin:0,countOfUsesPerHourAvg:0,countOfUsesPerHourMax:0,countOfUsesPerHourMin:0,countOfUsesPerMinuteAvg:0,countOfUsesPerMinuteMax:0,countOfUsesPerMinuteMin:0,countOfUsesPerSecondAvg:0,countOfUsesPerSecondMax:0,countOfUsesPerSecondMin:0,_deleteObj:t,_counter:{seconds:0,minutes:0,hours:0,days:0}};const i=this.metrics[e];return this.addTimers(t,i),{deleteObj:t,metric:i}}addTimers(e,s){const t=s._counter;this.addTimer(e,this.perSecondTimer,(()=>{(e=>{const s=e._counter;e.countOfUsesPerSecond=s.seconds,e.countOfUsesPerSecondMax=o(e.countOfUsesPerSecondMax,s.seconds),e.countOfUsesPerSecondMin=h(e.countOfUsesPerSecondMin,s.seconds),e.countOfUsesPerSecondAvg=a(e.countOfUsesPerSecondAvg,s.seconds)})(s),O(s),b(s),m(s),t.seconds=0})),this.addTimer(e,this.perMinuteTimer,(()=>{O(s),b(s),m(s),t.minutes=0})),this.addTimer(e,this.perHourTimer,(()=>{b(s),m(s),t.hours=0})),this.addTimer(e,this.perDayTimer,(()=>{m(s),t.days=0}))}clearFunc(){const e=[];for(const s in this.metrics)e.push(s);for(const s of e)this.deleteFunc(s)}getMetrics(e){const s={...this.metrics[e]};return delete s._deleteObj,delete s._counter,s}getAll(){const e={};for(const s in this.metrics)e[s]=this.getMetrics(s);return e}trackMetric(s){this._state===e.STARTED&&(s.countOfUses++,s._counter.seconds++,s._counter.minutes++,s._counter.hours++,s._counter.days++)}addTimer(e,s,t){const i=s.subscribeOnProcess((()=>{e.isDeleted?i?.unsubscribe():t()}))}};function P(e,s){const t=s||S;return t.start(),function(s,i,r){const n=r.value;let o=s.name||"this";const h=Object.prototype.toString.call(n),a=n[Symbol.toStringTag];let l;if("[object AsyncFunction]"===h||"AsyncFunction"===a){const s=e||`Async method: ${o}.${i}`;r.value=function(...e){return!l&&(l=t.decorateAsync(s,(e=>n.apply(this,e)))),l(e)}}else{const s=e||`Sync method: ${o}.${i}`;r.value=function(...e){return!l&&(l=t.decorate(s,(e=>n.apply(this,e)))),l(e)}}}}var A=function(e,s,t,i){var r,n=arguments.length,o=n<3?s:null===i?i=Object.getOwnPropertyDescriptor(s,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,s,t,i);else for(var h=e.length-1;h>=0;h--)(r=e[h])&&(o=(n<3?r(o):n>3?r(s,t,o):r(s,t))||o);return n>3&&o&&Object.defineProperty(s,t,o),o};class M{someMethod1(){console.log("someMethod1: This method is metered");for(let e=0;e<1e9;e++);}async someMethod2(){await new Promise((e=>setTimeout(e,100))),console.log("someMethod2: This method is metered")}}A([P()],M.prototype,"someMethod1",null),A([P()],M.prototype,"someMethod2",null);const g=S,v=new M;v.someMethod2().finally((()=>!0)),v.someMethod2().finally((()=>!0)),v.someMethod2().finally((()=>!0)),v.someMethod2().finally((()=>!0)),v.someMethod2().finally((()=>!0)),v.someMethod2().finally((()=>!0)),v.someMethod2().finally((()=>!0)),v.someMethod2().finally((()=>!0)),v.someMethod2().finally((()=>!0)),v.someMethod2().finally((()=>!0)),v.someMethod1(),v.someMethod1(),v.someMethod1(),v.someMethod1(),v.someMethod1(),v.someMethod1(),v.someMethod1(),setTimeout((()=>{console.log(g.getAll()),g.destroy()}),1e4)})();